<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: MethodAccessController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: MethodAccessController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

const DEFAULT_SECURITY_POLICY = require('./default-security-policy')

/**
 * Class that determines whether roles can invoke methods on classes, given optional contextual data.
 */
class MethodAccessController {
  /**
   * @param {SecurityPolicy} [policy] The security policy; defaults to a policy that grants all roles permission to invoke all roles on all classes.
   */
  constructor (policy) {
    policy = policy || DEFAULT_SECURITY_POLICY
    this._policy = policy
  }

  /**
   * Returns `true` if the given `role` is allowed to invoke the given `method` on the given `class`, given optional contextual `data`.
   * @param {object} arg The argument being deconstructed.
   * @param {string|string[]} arg.role The role or roles attempting to invoke `method` on an instance of `class`.
   * @param {string} arg.clazz The name of the class whose method is being invoked by `role`.
   * @param {string} arg.method The name of the method on an instance of `class` being invoked by `role`.
   * @param {any} [arg.data] Optional contextual data that can be used by the underlying access control strategy.
   * @return {boolean} Whether or not the `role` is allowed to invoke `method` on `class`.
   */
  grants ({ role, clazz, method, data }) {
    if (Array.isArray(role)) {
      return !role.map(it => this.denies({ role: it, clazz, method, data })).includes(true) &amp;&amp;
        role.map(it => this.grants({ role: it, clazz, method, data })).includes(true)
    }

    const entries = this._findEntries({ role, clazz, method })

    return !this._denies({ entries, role, clazz, method, data }) &amp;&amp;
      this._grants({ entries, role, clazz, method, data })
  }

  /**
   * Returns `true` if the given `role` is explicitly prevented from invoking the given `method` on the given `class`, given optional contextual `data`.
   * @param {object} arg The argument being deconstructed.
   * @param {string|string[]} arg.role The role or roles attempting to invoke `method` on an instance of `class`.
   * @param {string} arg.clazz The name of the class whose method is being invoked by `role`.
   * @param {string} arg.method The name of the method on an instance of `class` being invoked by `role`.
   * @param {any} [arg.data] Optional contextual data that can be used by the underlying access control strategy.
   * @return {boolean} Whether or not the `role` is explicitly prevented from invoking `method` on `class`.
   */
  denies ({ role, clazz, method, data }) {
    if (Array.isArray(role)) {
      const results = role.map(it => this.denies({ role: it, clazz, method, data }))
      return results.includes(true)
    }

    return this._denies({
      role, clazz, method, data, entries: this._findEntries({ role, clazz, method })
    })
  }

  _grants ({ entries, role, clazz, method, data }) {
    return this._interrogate({ entries, role, clazz, method, data, grant: true })
  }

  _denies ({ entries, role, clazz, method, data }) {
    return this._interrogate({ entries, role, clazz, method, data, grant: false })
  }

  _interrogate ({ entries, role, clazz, method, data, grant }) {
    for (const it of entries) {
      if (typeof it.strategy === 'boolean') {
        if (it.strategy === grant) return true
        continue
      }

      const fn = (typeof it.strategy === 'string') ? require(it.strategy) : it.strategy

      if (typeof fn === 'function') {
        const granted = fn({ role, clazz, method, data })
        if (grant &amp;&amp; granted) return true
        if (!grant &amp;&amp; !granted) return false
      } else {
        throw new Error('E_STRATEGY_NOT_A_FUNCTION')
      }
    }

    return false
  }

  _findEntries ({ role, clazz, method }) {
    return this._policy.filter(it =>
      it?.roles.test(role) &amp;&amp; it?.classes.test(clazz) &amp;&amp; it?.methods.test(method)
    )
  }
}

module.exports = MethodAccessController
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="MethodAccessController.html">MethodAccessController</a></li></ul><h3>Global</h3><ul><li><a href="global.html#DeniesDecisionFn">DeniesDecisionFn</a></li><li><a href="global.html#GrantsDecisionFn">GrantsDecisionFn</a></li><li><a href="global.html#policy">policy</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Mon May 11 2020 10:31:38 GMT-0500 (CDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
