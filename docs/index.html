<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Home</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Home</h1>

    



    


    <h3> </h3>










    




    <section>
        <article><h1>method-access-controller</h1>
<p>This library allows you to secure methods on classes.
Its fundamental capability is to be able to answer security questions like &quot;Can tellers close accounts?&quot;, assuming closing an account means to call the <code>close()</code> method on an instance of class <code>Account</code>.
The observant reader might correctly recognize this as role-based access control, which is true.
The role names (or &quot;types&quot;) are manifested as strings, and the securables are methods on classes.</p>
<p>This module exports a class called <code>MethodAccessController</code>.
It takes in its constructor a <code>SecurityPolicy</code>, which is an array of <code>SecurityPolicyEntry</code> objects.
A <code>SecurityPolicyEntry</code> is an object that looks like this:</p>
<pre class="prettyprint source lang-javascript"><code>const entry = {
  roles: /role names regex here/,
  classes: /class names regex here/,
  methods: /method names regex here/,
  strategy: true // values are true, false, a function, or a string
}
</code></pre>
<ul>
<li>If the <code>strategy</code> is the boolean literal <code>true</code>, then access is granted.</li>
<li>If the <code>strategy</code> is the boolean literal <code>false</code>, then access is expicitly denied.</li>
<li>If the <code>strategy</code> is a <code>function</code>, then it must be of the form <code>({role, clazz, method, data}): boolean</code> and will be invoked with the current role name, class name &amp; method name in question.</li>
<li>If the <code>strategy</code> is a <code>string</code>, then it is <code>require()</code>ed, expected to return a <code>function</code>, and invoked as above.</li>
</ul>
<p>A single denial vetoes all grants, and the absence of any grants results in denial.</p>
<h2>Usage</h2>
<p>This class can be used standalone, but it's really intended to be used in conjunction with an AOP implementation (shameless plug &amp; tip-o-the-hat to <a href="https://www.npmjs.com/package/@northscaler/aspectify">@northscaler/aspectify</a>) that can intercept method invocations with <code>before</code> advice.
In this manner, access control decisions can be made if user information is available to the advice that delegates to a <code>MethodAccessController</code>.</p>
<p>It's not really recommended, but in the absence of AOP, you'd use it in the following ways.</p>
<h3>Static Security Policies</h3>
<pre class="prettyprint source lang-javascript"><code>const context = require('...') // some means to get user from JWT or whatever

class Account {
  constructor(id, balance, /* ... */) {
    this.id = id
    this.balance = balance
    // ...
    this.controller = new MethodAccessController(require('./account-rbac-policy.json'))
  }
  
  // ...

  close() {
    // begin security check
    const roles = context.user?.roles

    if (roles && !roles.map(role => this.controller.grants({
      role,
      clazz: 'Account',
      method: 'close',
      data: this
    })).includes(true)) {
      const e = new Error('E_ACCESS_DENIED')
      e.context = { user: context.user, roles: context.user?.roles, clazz: 'Account', method: 'close'}
      throw e
    }
    // end security check

    this.open = false // or whatever
  }
}
</code></pre>
<h3>Dynamic (or Algorithmic) Security Policies</h3>
<p>You can use custom logic in your access control strategies.
Here's one that only lets <code>MANAGER</code>s close big <code>Account</code>s.</p>
<pre class="prettyprint source lang-javascript"><code>const strategy = it => it.role === 'MANAGER' || it.data?.balance &lt; 10000
// the above strategy assumes data is the Account instance

class Account {
  constructor(id, balance, /* ... */) {
    this.id = id
    this.balance = balance
    // ...
    this.controller = new MethodAccessController([{
      classes: /^Account$/,
      methods: /^close$/,
      roles: /^.+$/,
      strategy
    }])
  }
  
  // ...

  close() {
    // begin security check
    const roles = context.user?.roles

    if (roles && !roles.map(role => this.controller.grants({
      role,
      clazz: 'Account',
      method: 'close',
      data: this // this allows the strategy to check the account's balance
    })).includes(true)) {
      const e = new Error('E_ACCESS_DENIED')
      e.context = { user: context.user, roles: context.user?.roles, clazz: 'Account', method: 'close'}
      throw e
    }
    // end security check

    this.open = false // or whatever
  }
}
</code></pre></article>
    </section>






</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="MethodAccessController.html">MethodAccessController</a></li></ul><h3>Global</h3><ul><li><a href="global.html#DeniesDecisionFn">DeniesDecisionFn</a></li><li><a href="global.html#GrantsDecisionFn">GrantsDecisionFn</a></li><li><a href="global.html#policy">policy</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Mon May 11 2020 10:31:38 GMT-0500 (CDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>